# test-task

## Постановка задачи
Реализовать два http сервера, имитирующих учет голосов при голосовании:

Сервер 1 (С1) генерирует результы раунда голосования при запросе от Сервера 2 (С2).
С2 каждую секунду запрашивает и обрабатывает голоса.
С2 уведомляет С1 о каждом учтенном голосе ровно один раз.
С1 каждую секунду запрашивает у С1 состояние голосования.
При достаточном количестве голосов С1 уведомляет С2 о завершении, С2 генерирует голосование n+1.

3 участника:
1) генерит два голоса за (.., 1, true), (.., 1, true) каждый раунд.
2) меняет голос каждый раунд, участвует каждый раунд.
3) участвует только каждый 3 раунд. меняет голос после участия.

Участники могут одновременно иметь голоса за и против.
По достижении 3х голосов за или 2х против голосование завершается.

n - номер голосования.
i - номер раунда.
Сервер 1 выдает голоса ждет ожидает результата голосования:
 * GET /votes возращает голоса раунда i голосования n, инкрементирует раунд i
 * POST /notify принимает 1 нотификацию об учете голоса, на каждое второе обращение кидает исключение
 * POST /result/<id> принимает финальный результат по голосованию id, начинает новое голосование, если id == n
 * каждую секунду запрашивает состояние голосования n у C2

Сервер 2 считает голоса, пушит уведомления:
 * каждую секунду запрашивает C1 /votes
 * только первый голос участника за или против учитывается
 * на каждый учтенный голос асинхронно отправляется уведомление /notify с id голосовая, раунда и участника
 * каждый /notify должен быть успешно доставлен минимум 1 раз
 * при достаточном количестве голос вызывает C1 /result
 * результате голосования не подлежит изменению
 * /result должен быть успешно доставлен ровно 1 раз
 * GET /state/<id> возвращает состояние голосования id
 
Дополнительно:
реализовать сценарий голосования, показывающий, что результат голосования невозможно изменить продолжением голосования.
 
http клиент\сервер - на выбор.
Данные передавать в json.
Информацию о происходящем логировать в консоль.
Все необходимые данные необходимо держать в памяти в стандартных коллекциях Java


## vote-gen
Генерирует голоса.

### controllers
* [VoteGeneratorController](src/main/java/dev/nathan22177/votegen/controllers/VoteGeneratorController.java) - принимает вызов для получения голосов.

### exchange
* [Vote](src/main/java/dev/nathan22177/votegen/exchange/Vote.java) - Репрезентует 1 голос.
* [VoteBacth](src/main/java/dev/nathan22177/votegen/exchange/VoteBatch.java) - Служит для передачи голосов n голосования i раунда на сервер обрабатывающий голоса.
* [VotingResult](src/main/java/dev/nathan22177/votegen/exchange/VotingResult.java) - Принимается от обрабатывающего голоса сервера при завершении голосования.

### feedback
* [VoteGeneratorFeedbackController](src/main/java/dev/nathan22177/votegen/feedback/VoteGeneratorFeedbackController.java) - Принимает уведомления об учете голсов изавершении голосования.

### services
* [VoteGeneratorService](src/main/java/dev/nathan22177/votegen/services/VoteGeneratorService.java) - Генерирует голоса, обрабатывает завершение голосования.
* [VoteProcessingChecker](src/main/java/dev/nathan22177/votegen/services/VoteProcessingChecker.java) - Сверяется с сервером обработки о состоянии голосования.

### voters
* [Voters](src/main/java/dev/nathan22177/votegen/voters/Voters.java) - Описывает поведение участников.

## vote-proc
Обрабатывает голоса.

### common
* [Voting](src/main/java/dev/nathan22177/voteproc/common/Voting.java) - Репрезентует голосование.
* [VotingStatus](src/main/java/dev/nathan22177/voteproc/common/VotingStatus.java) - Отображает состояние голосования.

### controllers
* [VoteProcessingController](src/main/java/dev/nathan22177/voteproc/controllers/VoteProcessingController.java) - Принимает вызовы от генерирующего сервера о состоянии голосования.

### feedback
* [VoteGeneratorNotifier](src/main/java/dev/nathan22177/voteproc/feedback/VoteGeneratorNotifier.java) - Уведомляет генерирующий сервер об учете голоса и завершении голосования.

### services
* [VoteGeneratorRequestScheduler](src/main/java/dev/nathan22177/voteproc/services/VoteGeneratorRequestScheduler.java) - Запрашивает голоса у гененрирующего сервера.
* [VoteProcessingService](src/main/java/dev/nathan22177/voteproc/services/VoteProcessingService.java) - Обрабатывает приходящие голоса.

## Возникшие проблемы
* Не понимаю почему но тесты нормально не прогоняются в таске мавена но работают и дебажатся как положенно через идею.
* >каждый /notify должен быть успешно доставлен минимум 1 раз 
  >
  Не уверен в том что у меня адекватная политика ретраев. Прежде не сталкивался.
  
## Комментарии
* Все данные передаются в JSON из коробки через обжект маппер jackson который идет в комплекте с spring-web.
* Обрабатывающий сервер имеет зависимость на генерящий для того чтобы пользоваться классами из exchange. Если нужно было бы делать в разных репах, наверно делал бы интероп который друг к другу тянется. Если надо могу решить проблему более явной сериализацией\десериализацией.
* Использую ломбок исключительно воимя избежания написания одних и тех же дефолтных аксессоров. Могу от него избавиться если надо.

## TODO 
* какой нибудь более централизованный логгер потому что много мест где одни и те-же записи по сути.
* более тщательное тестирование обработки голосов и веб слоя обрабатывающего сервера.
